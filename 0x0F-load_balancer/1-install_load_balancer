#!/usr/bin/env bash
# Update and install HAProxy.

# Update and install necessary tools
sudo apt-get -y install --no-install-recommends software-properties-common

# Add the PPA for the latest HAProxy version
sudo add-apt-repository -y ppa:vbernat/haproxy-2.8

# Update package lists
sudo apt-get update

# Install the specific version of HAProxy
sudo apt-get -y install haproxy=2.8*

# Backup the original HAProxy configuration file
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Create a new HAProxy configuration file
sudo bash -c 'cat > /etc/haproxy/haproxy.cfg' <<EOF
frontend http-front
    bind *:80
    mode http
    default_backend http-back

backend http-back
    balance roundrobin
    server 471347-web-01 3.85.141.115:80 check
    server 471347-web-02 54.237.55.254:80 check
EOF

# Ensure HAProxy starts on boot (SysVinit method)
if [ -f /etc/init.d/haproxy ]; then
    sudo update-rc.d haproxy defaults
else
    echo "No init script found for HAProxy. Please ensure HAProxy is configured to start on boot manually."
fi

# Start HAProxy service
sudo service haproxy start

# Restart HAProxy to apply the new configuration
sudo service haproxy restart

# Check HAProxy status
sudo service haproxy status
